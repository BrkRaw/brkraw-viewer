name: Release On Merge

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: read

jobs:
  tag_release:
    if: ${{ github.repository == 'BrkRaw/brkraw-viewer' && github.event.pull_request.merged == true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.merge_commit_sha }}
      - name: Check release label
        id: release
        run: |
          python3 - <<'PY'
          import os

          labels = os.environ.get("PR_LABELS", "")
          allowed = "release" in {label.strip() for label in labels.split(",") if label.strip()}
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as handle:
              handle.write(f"allowed={'true' if allowed else 'false'}\n")
          PY
        env:
          PR_LABELS: ${{ join(github.event.pull_request.labels.*.name, ',') }}
      - name: Resolve version
        id: version
        run: |
          version=$(python3 - <<'PY'
          import re
          from pathlib import Path

          def read_version_from_init() -> str | None:
              init_path = Path("src/brkraw_viewer/__init__.py")
              if not init_path.exists():
                  return None
              text = init_path.read_text(encoding="utf-8")
              match = re.search(r"__version__\\s*=\\s*['\\\"]([^'\\\"]+)['\\\"]", text)
              if not match:
                  return None
              return match.group(1)

          def read_version_from_pyproject() -> str | None:
              pyproject = Path("pyproject.toml")
              if not pyproject.exists():
                  return None
              text = pyproject.read_text(encoding="utf-8")
              try:
                  import tomllib
              except ModuleNotFoundError:  # pragma: no cover
                  import tomli as tomllib
              data = tomllib.loads(text)
              return data.get("project", {}).get("version")

          version = read_version_from_init() or read_version_from_pyproject()
          if not version:
              raise SystemExit("No version found in src/brkraw_viewer/__init__.py or pyproject.toml")
          print(version)
          PY
          )
          echo "value=$version" >> "$GITHUB_OUTPUT"
      - name: Check tag exists
        id: tag
        run: |
          tag="${{ steps.version.outputs.value }}"
          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Create and push tag
        if: ${{ steps.release.outputs.allowed == 'true' && steps.tag.outputs.exists == 'false' }}
        run: |
          tag="${{ steps.version.outputs.value }}"
          git tag "$tag" "${{ github.event.pull_request.merge_commit_sha }}"
          git push origin "$tag"
