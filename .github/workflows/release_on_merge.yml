name: Release On Merge

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  tag_release:
    if: ${{ github.repository == 'BrkRaw/brkraw-viewer' && github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'release') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.merge_commit_sha }}
      - name: Detect version change
        id: version
        run: |
          base_sha="${{ github.event.pull_request.base.sha }}"
          merge_sha="${{ github.event.pull_request.merge_commit_sha }}"
          echo "Inspecting src/brkraw_viewer/__init__.py at $merge_sha"
          git show "$merge_sha:src/brkraw_viewer/__init__.py" || true
          if ! git diff --name-only "$base_sha" "$merge_sha" | grep -q '^src/brkraw_viewer/__init__.py$'; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          version=$(python3 - <<'PY'
          import re
          from pathlib import Path

          def read_version_from_init() -> str | None:
              init_path = Path("src/brkraw_viewer/__init__.py")
              if not init_path.exists():
                  return None
              text = init_path.read_text(encoding="utf-8")
              match = re.search(r"__version__\\s*=\\s*['\\\"]([^'\\\"]+)['\\\"]", text)
              if not match:
                  return None
              return match.group(1)

          def read_version_from_pyproject() -> str | None:
              pyproject = Path("pyproject.toml")
              if not pyproject.exists():
                  return None
              text = pyproject.read_text(encoding="utf-8")
              try:
                  import tomllib
              except ModuleNotFoundError:  # pragma: no cover
                  import tomli as tomllib
              data = tomllib.loads(text)
              return data.get("project", {}).get("version")

          version = read_version_from_init() or read_version_from_pyproject()
          if not version:
              raise SystemExit("No version found in src/brkraw_viewer/__init__.py or pyproject.toml")
          print(version)
          PY
          )
          echo "changed=true" >> "$GITHUB_OUTPUT"
          echo "value=$version" >> "$GITHUB_OUTPUT"
      - name: Create and push tag
        if: ${{ steps.version.outputs.changed == 'true' }}
        run: |
          tag="${{ steps.version.outputs.value }}"
          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "Tag $tag already exists. Skipping."
            exit 0
          fi
          git tag "$tag" "${{ github.event.pull_request.merge_commit_sha }}"
          git push origin "$tag"
