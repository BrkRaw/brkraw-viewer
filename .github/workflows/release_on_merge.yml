name: Release On Merge

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  tag_release:
    if: ${{ github.repository == 'BrkRaw/brkraw-viewer' && github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'release') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect version change
        id: version
        run: |
          base_sha="${{ github.event.pull_request.base.sha }}"
          merge_sha="${{ github.event.pull_request.merge_commit_sha }}"
          if ! git diff --name-only "$base_sha" "$merge_sha" | grep -q '^src/brkraw_viewer/__init__.py$'; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          version=$(python3 - <<'PY'
          import re
          import subprocess

          merge_sha = "${{ github.event.pull_request.merge_commit_sha }}"
          result = subprocess.run(
              ["git", "show", f"{merge_sha}:src/brkraw_viewer/__init__.py"],
              check=False,
              capture_output=True,
              text=True,
          )
          if result.returncode != 0:
              raise SystemExit("Failed to read src/brkraw_viewer/__init__.py from merge commit")
          match = re.search(r"__version__\\s*=\\s*['\\\"]([^'\\\"]+)['\\\"]", result.stdout)
          if not match:
              raise SystemExit("No __version__ found in src/brkraw_viewer/__init__.py")
          print(match.group(1))
          PY
          )
          echo "changed=true" >> "$GITHUB_OUTPUT"
          echo "value=$version" >> "$GITHUB_OUTPUT"
      - name: Create and push tag
        if: ${{ steps.version.outputs.changed == 'true' }}
        run: |
          tag="${{ steps.version.outputs.value }}"
          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "Tag $tag already exists. Skipping."
            exit 0
          fi
          git tag "$tag" "${{ github.event.pull_request.merge_commit_sha }}"
          git push origin "$tag"
