name: Release On Merge

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: read

jobs:
  tag_release:
    if: ${{ github.repository == 'BrkRaw/brkraw-viewer' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check release label
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          python3 - <<'PY'
          import json
          import os
          from urllib import request

          token = os.environ.get("GITHUB_TOKEN")
          repo = os.environ["GITHUB_REPOSITORY"]
          sha = os.environ["GITHUB_SHA"]

          url = f"https://api.github.com/repos/{repo}/commits/{sha}/pulls?per_page=10"
          req = request.Request(url)
          req.add_header("Authorization", f"Bearer {token}")
          req.add_header("Accept", "application/vnd.github+json")
          with request.urlopen(req) as resp:
              pulls = json.loads(resp.read().decode("utf-8"))

          allowed = False
          for pr in pulls:
              if not pr.get("merged_at"):
                  continue
              labels = {label.get("name") for label in pr.get("labels", [])}
              if "release" in labels:
                  allowed = True
                  break

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as handle:
              handle.write(f"allowed={'true' if allowed else 'false'}\n")
          PY
      - name: Detect version change
        id: version
        run: |
          base_sha="${{ github.event.before }}"
          merge_sha="${{ github.sha }}"
          echo "Inspecting src/brkraw_viewer/__init__.py at $merge_sha"
          git show "$merge_sha:src/brkraw_viewer/__init__.py" || true
          if ! git diff --name-only "$base_sha" "$merge_sha" | grep -Eq '^(src/brkraw_viewer/__init__.py|pyproject.toml)$'; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          version=$(python3 - <<'PY'
          import re
          from pathlib import Path

          def read_version_from_init() -> str | None:
              init_path = Path("src/brkraw_viewer/__init__.py")
              if not init_path.exists():
                  return None
              text = init_path.read_text(encoding="utf-8")
              match = re.search(r"__version__\\s*=\\s*['\\\"]([^'\\\"]+)['\\\"]", text)
              if not match:
                  return None
              return match.group(1)

          def read_version_from_pyproject() -> str | None:
              pyproject = Path("pyproject.toml")
              if not pyproject.exists():
                  return None
              text = pyproject.read_text(encoding="utf-8")
              try:
                  import tomllib
              except ModuleNotFoundError:  # pragma: no cover
                  import tomli as tomllib
              data = tomllib.loads(text)
              return data.get("project", {}).get("version")

          version = read_version_from_init() or read_version_from_pyproject()
          if not version:
              raise SystemExit("No version found in src/brkraw_viewer/__init__.py or pyproject.toml")
          print(version)
          PY
          )
          echo "changed=true" >> "$GITHUB_OUTPUT"
          echo "value=$version" >> "$GITHUB_OUTPUT"
      - name: Create and push tag
        if: ${{ steps.release.outputs.allowed == 'true' && steps.version.outputs.changed == 'true' }}
        run: |
          tag="${{ steps.version.outputs.value }}"
          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "Tag $tag already exists. Skipping."
            exit 0
          fi
          git tag "$tag" "${{ github.event.pull_request.merge_commit_sha }}"
          git push origin "$tag"
